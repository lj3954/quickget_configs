name: Create quickget configs

on:
  schedule:
    - cron: '58 23 * * *'
  workflow_dispatch:
  repository_dispatch:
    types: [ generate_configuration ]

jobs:
  create_configs:
    permissions:
      contents: write
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          repository: 'lj3954/quickemu-rs'
      - uses: actions/checkout@v4
        with:
          branch: master
      - name: Restore cache
        uses: actions/cache/restore@v4
        with:
          path: target/release/quickget_ci
          key: ${{ runner.os }}-quickget_ci-${{ hashFiles('**/Cargo.lock') }}

      - name: Install zstd
        run: sudo apt-get install -y zstd

      - name: Create configs
        run: |
          ./target/release/quickget_ci
          zstd -19 -o quickget_data.json.zst quickget_data.json
          gzip -9 -k quickget_data.json

      - name: Commit uncompressed JSON
        uses: amousavigourabi/push-action@v0
        with:
          message: 'ci: update quickget configurations'
          branch: master
          files: 'quickget_data.json'

      - name: Release archives
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: 'quickget_data.json.zst, quickget_data.json.gz'
          artifactContentType: 'application/octet-stream'
          body: 'Quickget configuration files (Compressed)'
          token: ${{ secrets.GITHUB_TOKEN }}
          name: "Quickget configurations (Compressed)"
          tag: 'daily'
